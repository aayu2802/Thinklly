{% extends 'akademi/elements/layouts/admin.html' %}
		
{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='akademi/vendor/jquery-smartwizard/dist/css/smart_wizard.min.css')}}">
<link rel="stylesheet" href="{{ url_for('static', filename='akademi/vendor/bootstrap-datepicker-master/css/bootstrap-datepicker.min.css')}}">
<link rel="stylesheet" href="{{ url_for('static', filename='akademi/vendor/jquery-nice-select/css/nice-select.css')}}">
<style>
    .required { color: #ff0000; }
    
    /* Avatar upload centering */
    .avatar-upload { 
        position: relative; 
        max-width: 205px; 
        margin: 0 auto; 
        text-align: center;
    }
    .avatar-upload .avatar-preview { 
        width: 192px; 
        height: 192px; 
        position: relative; 
        border-radius: 100%; 
        border: 6px solid #F8F8F8; 
        box-shadow: 0px 2px 4px 0px rgba(0, 0, 0, 0.1); 
        margin: 0 auto;
    }
    .avatar-upload .avatar-preview > div { 
        width: 100%; 
        height: 100%; 
        border-radius: 100%; 
        background-size: cover; 
        background-repeat: no-repeat; 
        background-position: center; 
        margin-top: 40px;
    }
    
    /* Fix SmartWizard height issues */
    .sw-container {
        min-height: auto !important;
        height: auto !important;
    }
    .tab-content > .tab-pane {
        min-height: auto !important;
        height: auto !important;
    }
    #smartwizard .tab-content {
        height: auto !important;
        min-height: 500px;
    }
    
    /* Center tab numbers in wizard navigation */
    #smartwizard .nav-wizard .nav-link span {
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
    
    /* Make inactive tabs have white background */
    #smartwizard .nav-wizard .nav-link span {
        background-color: #fff !important;
        color: #717579 !important;
    }
    
    /* Active tab styling */
    #smartwizard .nav-wizard .nav-link.active span,
    #smartwizard .nav-wizard .nav-link.done span {
        border-color: var(--primary) !important;
        background-color: var(--primary) !important;
        color: #fff !important;
    }
    
    #smartwizard .nav-wizard .nav-link p {
        text-align: center;
        margin: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="content-body">
    <div class="container-fluid">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <!-- row -->
        <div class="row">
            <div class="col-xl-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Complete Student Profile</h4>
                        <p class="mb-0">Admission No: <strong>{{ student.admission_number }}</strong> | Name: <strong>{{ student.full_name }}</strong></p>
                    </div>
                    <div class="card-body">
                        <form method="POST" enctype="multipart/form-data" id="studentProfileForm">
                            <input type="hidden" name="current_tab" id="current_tab" value="{{ current_tab|default(0) }}">
                            <div id="smartwizard" class="form-wizard order-create">
                                <ul class="nav nav-wizard">
                                    <li><a class="nav-link" href="#wizard_basic"> 
                                        <span>1</span> 
                                        <p class="mt-2 mb-0">Basic Info</p>
                                    </a></li>
                                    <li><a class="nav-link" href="#wizard_guardian">
                                        <span>2</span>
                                        <p class="mt-2 mb-0">Guardian</p>
                                    </a></li>
                                    <li><a class="nav-link" href="#wizard_medical">
                                        <span>3</span>
                                        <p class="mt-2 mb-0">Medical</p>
                                    </a></li>
                                    <li><a class="nav-link" href="#wizard_previous_sibling">
                                        <span>4</span>
                                        <p class="mt-2 mb-0">Previous & Sibling</p>
                                    </a></li>
                                    <li><a class="nav-link" href="#wizard_documents">
                                        <span>5</span>
                                        <p class="mt-2 mb-0">Documents</p>
                                    </a></li>
                                </ul>
                                <div class="tab-content">
                                    <!-- TAB 1: Basic Info -->
                                    <div id="wizard_basic" class="tab-pane" role="tabpanel">
                                        <div class="row">
                                            <div class="col-lg-6">
                                                <h5 class="mb-3 text-primary">Personal Information</h5>
                                                <div class="mb-3">
                                                    <label class="form-label">Admission Number<span class="required">*</span></label>
                                                    <input type="text" name="admission_number" class="form-control" value="{{ student.admission_number }}" readonly>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">First Name<span class="required">*</span></label>
                                                    <input type="text" name="first_name" class="form-control" value="{{ student.first_name }}" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Last Name<span class="required">*</span></label>
                                                    <input type="text" name="last_name" class="form-control" value="{{ student.last_name }}" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Date of Birth<span class="required">*</span></label>
                                                    <input type="text" name="date_of_birth" class="form-control datepicker" value="{{ student.date_of_birth.strftime('%Y-%m-%d') if student.date_of_birth else '' }}" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Gender<span class="required">*</span></label>
                                                    <select name="gender" class="form-control" required>
                                                        <option value="Male" {% if student.gender.value == 'Male' %}selected{% endif %}>Male</option>
                                                        <option value="Female" {% if student.gender.value == 'Female' %}selected{% endif %}>Female</option>
                                                        <option value="Other" {% if student.gender.value == 'Other' %}selected{% endif %}>Other</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Class<span class="required">*</span></label>
                                                    <select name="class_id" class="form-control" required>
                                                        {% for c in classes %}
                                                        <option value="{{ c.id }}" {% if student.class_id == c.id %}selected{% endif %}>{{ c.class_name }}-{{ c.section }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Session<span class="required">*</span></label>
                                                    <select name="session_id" class="form-control" required>
                                                        {% for s in sessions %}
                                                        <option value="{{ s.id }}" {% if student.session_id == s.id %}selected{% endif %}>{{ s.session_name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Roll Number</label>
                                                    <input type="text" name="roll_number" class="form-control" value="{{ student.roll_number or '' }}" placeholder="Optional roll / serial">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Category</label>
                                                    <select name="category" class="form-control">
                                                        <option value="General" {% if student.category.value == 'General' %}selected{% endif %}>General</option>
                                                        <option value="SC" {% if student.category.value == 'SC' %}selected{% endif %}>SC</option>
                                                        <option value="ST" {% if student.category.value == 'ST' %}selected{% endif %}>ST</option>
                                                        <option value="OBC" {% if student.category.value == 'OBC' %}selected{% endif %}>OBC</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Blood Group</label>
                                                    <select name="blood_group" class="form-control">
                                                        <option value="">Select Blood Group</option>
                                                        <option value="A+" {% if student.blood_group == 'A+' %}selected{% endif %}>A+</option>
                                                        <option value="A-" {% if student.blood_group == 'A-' %}selected{% endif %}>A-</option>
                                                        <option value="B+" {% if student.blood_group == 'B+' %}selected{% endif %}>B+</option>
                                                        <option value="B-" {% if student.blood_group == 'B-' %}selected{% endif %}>B-</option>
                                                        <option value="AB+" {% if student.blood_group == 'AB+' %}selected{% endif %}>AB+</option>
                                                        <option value="AB-" {% if student.blood_group == 'AB-' %}selected{% endif %}>AB-</option>
                                                        <option value="O+" {% if student.blood_group == 'O+' %}selected{% endif %}>O+</option>
                                                        <option value="O-" {% if student.blood_group == 'O-' %}selected{% endif %}>O-</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Aadhar Number</label>
                                                    <input type="text" name="aadhar_number" class="form-control" value="{{ student.aadhar_number or '' }}" maxlength="12">
                                                </div>
                                            </div>
                                            <div class="col-lg-6">
                                                <h5 class="mb-3 text-primary">Photo & Contact</h5>
                                                <div class="mb-3">
                                                    <label class="form-label">Student Photo</label>
                                                    <div class="avatar-upload">
                                                        <div class="avatar-preview">
                                                            <div id="imagePreview" style="background-image: url({% if student.photo_url %}{{ url_for('static', filename=student.photo_url) }}{% else %}{{ url_for('static', filename='akademi/images/no-img-avatar.png') }}{% endif %});"></div>
                                                        </div>
                                                        <div class="change-btn mt-1 text-center">
                                                            <input type='file' class="form-control d-none" id="imageUpload" name="photo" accept=".png, .jpg, .jpeg">
                                                            <label for="imageUpload" class="dlab-upload mb-0 btn btn-primary btn-sm">Choose Photo</label>
                                                            <a href="javascript:void(0);" class="btn btn-danger light remove-img ms-2 btn-sm">Remove</a>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Email</label>
                                                    <input type="email" name="email" class="form-control" value="{{ student.email or '' }}">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Phone</label>
                                                    <input type="text" name="phone" class="form-control" value="{{ student.phone or '' }}">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Address</label>
                                                    <textarea name="address" class="form-control" rows="3">{{ student.address or '' }}</textarea>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">City</label>
                                                    <input type="text" name="city" class="form-control" value="{{ student.city or '' }}">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">State</label>
                                                    <input type="text" name="state" class="form-control" value="{{ student.state or '' }}">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Pincode</label>
                                                    <input type="text" name="pincode" class="form-control" value="{{ student.pincode or '' }}">
                                                </div>
                                            </div>
                                        </div>
                                        <hr class="my-4">
                                        <div class="row">
                                            <div class="col-lg-12">
                                                <h5 class="mb-3 text-primary">Guardian Basic Information</h5>
                                                <p class="text-muted">Basic guardian details (Extended details in next tab)</p>
                                            </div>
                                            <div class="col-lg-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Father's Name<span class="required">*</span></label>
                                                    <input type="text" name="father_name" class="form-control" value="{{ student.father_name }}" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Mother's Name</label>
                                                    <input type="text" name="mother_name" class="form-control" value="{{ student.mother_name or '' }}">
                                                </div>
                                            </div>
                                            <div class="col-lg-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Guardian Phone<span class="required">*</span></label>
                                                    <input type="text" name="guardian_phone" class="form-control" value="{{ student.guardian_phone }}" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Guardian Email</label>
                                                    <input type="email" name="guardian_email" class="form-control" value="{{ student.guardian_email or '' }}">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Tab Navigation Buttons -->
                                        <hr class="my-4">
                                        <div class="row">
                                            <div class="col-12 d-flex justify-content-between">
                                                <button type="button" class="btn btn-secondary tab-prev-btn">
                                                    <i class="fas fa-arrow-left me-2"></i>Previous
                                                </button>
                                                <div>
                                                    <button type="submit" name="action" value="save" class="btn btn-success me-2">
                                                        <i class="fas fa-save me-2"></i>Save
                                                    </button>
                                                    <button type="button" class="btn btn-primary tab-next-btn">
                                                        Next<i class="fas fa-arrow-right ms-2"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- TAB 2: Guardian Details -->
                                    <div id="wizard_guardian" class="tab-pane" role="tabpanel">
                                        <div class="row">
                                            <div class="col-lg-12">
                                                <h5 class="mb-3 text-primary">Extended Guardian Information</h5>
                                                <p class="text-muted">Additional details about guardians (occupation, income, alternate contact)</p>
                                            </div>
                                        </div>
                                        
                                        <!-- Father Details -->
                                        <div class="card mb-3">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0"><i class="fas fa-male me-2"></i>Father's Details</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <div class="mb-3">
                                                            <label class="form-label">Occupation</label>
                                                            <input type="text" name="father_occupation" class="form-control" 
                                                                   value="{% for g in student.guardians %}{% if g.guardian_type.value == 'Father' %}{{ g.occupation or '' }}{% endif %}{% endfor %}" 
                                                                   placeholder="e.g., Engineer, Teacher">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="mb-3">
                                                            <label class="form-label">Annual Income (₹)</label>
                                                            <input type="number" name="father_income" class="form-control" step="0.01"
                                                                   value="{% for g in student.guardians %}{% if g.guardian_type.value == 'Father' %}{{ g.annual_income or '' }}{% endif %}{% endfor %}" 
                                                                   placeholder="e.g., 500000">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="mb-3">
                                                            <label class="form-label">Alternate Phone</label>
                                                            <input type="text" name="father_phone_alt" class="form-control" 
                                                                   value="{% for g in student.guardians %}{% if g.guardian_type.value == 'Father' %}{{ g.phone_alternate or '' }}{% endif %}{% endfor %}" 
                                                                   placeholder="Secondary contact">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Mother Details -->
                                        <div class="card mb-3">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0"><i class="fas fa-female me-2"></i>Mother's Details</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <div class="mb-3">
                                                            <label class="form-label">Occupation</label>
                                                            <input type="text" name="mother_occupation" class="form-control" 
                                                                   value="{% for g in student.guardians %}{% if g.guardian_type.value == 'Mother' %}{{ g.occupation or '' }}{% endif %}{% endfor %}" 
                                                                   placeholder="e.g., Doctor, Homemaker">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="mb-3">
                                                            <label class="form-label">Annual Income (₹)</label>
                                                            <input type="number" name="mother_income" class="form-control" step="0.01"
                                                                   value="{% for g in student.guardians %}{% if g.guardian_type.value == 'Mother' %}{{ g.annual_income or '' }}{% endif %}{% endfor %}" 
                                                                   placeholder="e.g., 300000">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="mb-3">
                                                            <label class="form-label">Alternate Phone</label>
                                                            <input type="text" name="mother_phone_alt" class="form-control" 
                                                                   value="{% for g in student.guardians %}{% if g.guardian_type.value == 'Mother' %}{{ g.phone_alternate or '' }}{% endif %}{% endfor %}" 
                                                                   placeholder="Secondary contact">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Other Guardian Details (Optional) -->
                                        <div class="card mb-3">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0"><i class="fas fa-user me-2"></i>Other Guardian (Optional)</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-4">
                                                        <div class="mb-3">
                                                            <label class="form-label">Occupation</label>
                                                            <input type="text" name="other_occupation" class="form-control" 
                                                                   value="{% for g in student.guardians %}{% if g.guardian_type.value == 'Other' %}{{ g.occupation or '' }}{% endif %}{% endfor %}" 
                                                                   placeholder="e.g., Uncle, Aunt">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="mb-3">
                                                            <label class="form-label">Annual Income (₹)</label>
                                                            <input type="number" name="other_income" class="form-control" step="0.01"
                                                                   value="{% for g in student.guardians %}{% if g.guardian_type.value == 'Other' %}{{ g.annual_income or '' }}{% endif %}{% endfor %}">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="mb-3">
                                                            <label class="form-label">Alternate Phone</label>
                                                            <input type="text" name="other_phone_alt" class="form-control" 
                                                                   value="{% for g in student.guardians %}{% if g.guardian_type.value == 'Other' %}{{ g.phone_alternate or '' }}{% endif %}{% endfor %}">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Tab Navigation Buttons -->
                                        <hr class="my-4">
                                        <div class="row">
                                            <div class="col-12 d-flex justify-content-between">
                                                <button type="button" class="btn btn-secondary tab-prev-btn">
                                                    <i class="fas fa-arrow-left me-2"></i>Previous
                                                </button>
                                                <div>
                                                    <button type="submit" name="action" value="save" class="btn btn-success me-2">
                                                        <i class="fas fa-save me-2"></i>Save
                                                    </button>
                                                    <button type="button" class="btn btn-primary tab-next-btn">
                                                        Next<i class="fas fa-arrow-right ms-2"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- TAB 3: Medical Information -->
                                    <div id="wizard_medical" class="tab-pane" role="tabpanel">
                                        <div class="row">
                                            <div class="col-lg-12">
                                                <h5 class="mb-3 text-primary">Medical & Health Information</h5>
                                                <p class="text-muted">Important medical information for emergencies</p>
                                            </div>
                                            <div class="col-lg-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Known Allergies</label>
                                                    <textarea name="allergies" class="form-control" rows="3" 
                                                              placeholder="List any known allergies (food, medicine, etc.)">{{ student.medical_info.allergies if student.medical_info else '' }}</textarea>
                                                    <small class="form-text text-muted">e.g., Peanuts, Penicillin, Pollen</small>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Medical Conditions</label>
                                                    <textarea name="medical_conditions" class="form-control" rows="3" 
                                                              placeholder="Any chronic conditions or medical history">{{ student.medical_info.medical_conditions if student.medical_info else '' }}</textarea>
                                                    <small class="form-text text-muted">e.g., Asthma, Diabetes, Heart condition</small>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Emergency Medication</label>
                                                    <input type="text" name="emergency_medication" class="form-control" 
                                                           value="{{ student.medical_info.emergency_medication if student.medical_info else '' }}" 
                                                           placeholder="e.g., Inhaler, Insulin">
                                                    <small class="form-text text-muted">Medications student must carry/take regularly</small>
                                                </div>
                                            </div>
                                            <div class="col-lg-6">
                                                <div class="mb-3">
                                                    <label class="form-label">Doctor's Name</label>
                                                    <input type="text" name="doctor_name" class="form-control" 
                                                           value="{{ student.medical_info.doctor_name if student.medical_info else '' }}" 
                                                           placeholder="Family doctor or pediatrician">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Doctor's Phone</label>
                                                    <input type="text" name="doctor_phone" class="form-control" 
                                                           value="{{ student.medical_info.doctor_phone if student.medical_info else '' }}" 
                                                           placeholder="Emergency contact number">
                                                </div>
                                                <div class="alert alert-info mt-4">
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    <strong>Note:</strong> This information is kept confidential and used only in case of medical emergencies.
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Tab Navigation Buttons -->
                                        <hr class="my-4">
                                        <div class="row">
                                            <div class="col-12 d-flex justify-content-between">
                                                <button type="button" class="btn btn-secondary tab-prev-btn">
                                                    <i class="fas fa-arrow-left me-2"></i>Previous
                                                </button>
                                                <div>
                                                    <button type="submit" name="action" value="save" class="btn btn-success me-2">
                                                        <i class="fas fa-save me-2"></i>Save
                                                    </button>
                                                    <button type="button" class="btn btn-primary tab-next-btn">
                                                        Next<i class="fas fa-arrow-right ms-2"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- TAB 4: Previous School & Siblings -->
                                    <div id="wizard_previous_sibling" class="tab-pane" role="tabpanel">
                                        <div class="row">
                                            <div class="col-lg-12">
                                                <h5 class="mb-3 text-primary">Previous School Records</h5>
                                                <p class="text-muted">Add previous school details and transfer certificate information</p>
                                            </div>
                                            <div class="col-lg-12">
                                                <div id="previous-schools-container">
                                                    {% if student.previous_schools %}
                                                        {% for ps in student.previous_schools %}
                                                        <div class="prev-school-row mb-3 p-3 border rounded bg-light">
                                                            <div class="row">
                                                                <div class="col-md-4">
                                                                    <div class="mb-3">
                                                                        <label class="form-label">School Name<span class="required">*</span></label>
                                                                        <input type="text" name="prev_school_name[]" class="form-control" value="{{ ps.school_name }}" required>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-3">
                                                                    <div class="mb-3">
                                                                        <label class="form-label">Last Class</label>
                                                                        <input type="text" name="prev_school_class[]" class="form-control" value="{{ ps.last_class or '' }}">
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-3">
                                                                    <div class="mb-3">
                                                                        <label class="form-label">TC Number</label>
                                                                        <input type="text" name="prev_school_tc[]" class="form-control" value="{{ ps.tc_number or '' }}">
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-2">
                                                                    <button type="button" class="btn btn-danger btn-sm mt-4 remove-prev-school">Remove</button>
                                                                </div>
                                                                <div class="col-md-3">
                                                                    <div class="mb-3">
                                                                        <label class="form-label">TC Date</label>
                                                                        <input type="text" name="prev_school_tc_date[]" class="form-control datepicker" value="{{ ps.tc_date.strftime('%Y-%m-%d') if ps.tc_date else '' }}">
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-3">
                                                                    <div class="mb-3">
                                                                        <label class="form-label">Last Percentage</label>
                                                                        <input type="number" name="prev_school_percentage[]" class="form-control" step="0.01" value="{{ ps.last_percentage or '' }}">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% endfor %}
                                                    {% endif %}
                                                </div>
                                                <button type="button" class="btn btn-primary btn-sm" id="add-prev-school">
                                                    <i class="fas fa-plus"></i> Add Previous School
                                                </button>
                                            </div>
                                        </div>

                                        <hr class="my-4">

                                        <!-- Siblings Section -->
                                        <div class="row">
                                            <div class="col-lg-12">
                                                <h5 class="mb-3 text-primary">Sibling Information</h5>
                                                <p class="text-muted">Add sibling details (in same school or other schools)</p>
                                            </div>
                                            <div class="col-lg-12">
                                                <div id="siblings-container">
                                                    {% if student.siblings %}
                                                        {% for sib in student.siblings %}
                                                        <div class="sibling-row mb-3 p-3 border rounded bg-light">
                                                            <div class="row">
                                                                <div class="col-md-3">
                                                                    <div class="mb-3">
                                                                        <label class="form-label">Sibling Name<span class="required">*</span></label>
                                                                        <input type="text" name="sibling_name[]" class="form-control" value="{{ sib.sibling_name }}" required>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-2">
                                                                    <div class="mb-3">
                                                                        <label class="form-label">Class</label>
                                                                        <input type="text" name="sibling_class[]" class="form-control" value="{{ sib.sibling_class or '' }}">
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-2">
                                                                    <div class="mb-3">
                                                                        <label class="form-label">Admission No</label>
                                                                        <input type="text" name="sibling_admission[]" class="form-control" value="{{ sib.sibling_admission_number or '' }}">
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-2">
                                                                    <div class="form-check mt-4">
                                                                        <input class="form-check-input" type="checkbox" name="sibling_same_school[]" value="1" {% if sib.is_in_same_school %}checked{% endif %}>
                                                                        <label class="form-check-label">Same School</label>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-2">
                                                                    <button type="button" class="btn btn-danger btn-sm mt-4 remove-sibling">Remove</button>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <div class="mb-3">
                                                                        <label class="form-label">Other School Name</label>
                                                                        <input type="text" name="sibling_other_school[]" class="form-control" value="{{ sib.other_school_name or '' }}" placeholder="If not in same school">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {% endfor %}
                                                    {% endif %}
                                                </div>
                                                <button type="button" class="btn btn-primary btn-sm" id="add-sibling">
                                                    <i class="fas fa-plus"></i> Add Sibling
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <!-- Tab Navigation Buttons -->
                                        <hr class="my-4">
                                        <div class="row">
                                            <div class="col-12 d-flex justify-content-between">
                                                <button type="button" class="btn btn-secondary tab-prev-btn">
                                                    <i class="fas fa-arrow-left me-2"></i>Previous
                                                </button>
                                                <div>
                                                    <button type="submit" name="action" value="save" class="btn btn-success me-2">
                                                        <i class="fas fa-save me-2"></i>Save
                                                    </button>
                                                    <button type="button" class="btn btn-primary tab-next-btn">
                                                        Next<i class="fas fa-arrow-right ms-2"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- TAB 5: Documents -->
                                    <div id="wizard_documents" class="tab-pane" role="tabpanel">
                                        <div class="row">
                                            <div class="col-lg-12">
                                                <h5 class="mb-3 text-primary">Document Upload</h5>
                                                <p class="text-muted">Upload important documents like birth certificate, aadhar, TC, marksheets</p>
                                            </div>
                                            <div class="col-lg-12">
                                                <div class="card">
                                                    <div class="card-body">
                                                        <div id="documents-container">
                                                            {% if student.documents %}
                                                                <table class="table table-bordered">
                                                                    <thead>
                                                                        <tr>
                                                                            <th>Document Type</th>
                                                                            <th>File Name</th>
                                                                            <th>Uploaded</th>
                                                                            <th>Action</th>
                                                                        </tr>
                                                                    </thead>
                                                                    <tbody>
                                                                        {% for doc in student.documents %}
                                                                        <tr>
                                                                            <td>{{ doc.doc_type.value if doc.doc_type else 'N/A' }}</td>
                                                                            <td>{{ doc.file_name }}</td>
                                                                            <td>{{ doc.uploaded_at.strftime('%d %b, %Y') if doc.uploaded_at else 'N/A' }}</td>
                                                                            <td>
                                                                                <a href="{{ url_for('static', filename=doc.file_path) }}" class="btn btn-sm btn-primary" target="_blank">
                                                                                    <i class="fa fa-download"></i> View
                                                                                </a>
                                                                                <button type="button" class="btn btn-sm btn-danger ms-2 delete-doc" data-doc-id="{{ doc.id }}">
                                                                                    <i class="fa fa-trash"></i>
                                                                                </button>
                                                                            </td>
                                                                        </tr>
                                                                        {% endfor %}
                                                                    </tbody>
                                                                </table>
                                                            {% else %}
                                                                <p class="text-muted">No documents uploaded yet</p>
                                                            {% endif %}
                                                        </div>
                                                        <hr class="my-4">
                                                        <h6 class="mb-3">Upload New Documents</h6>
                                                        <div id="upload-documents-container">
                                                            <!-- Dynamic document upload rows will be added here -->
                                                        </div>
                                                        <button type="button" class="btn btn-sm btn-primary mb-3" id="add-document-row">
                                                            <i class="fas fa-plus"></i> Add Document
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Tab Navigation Buttons -->
                                        <hr class="my-4">
                                        <div class="row">
                                            <div class="col-12 d-flex justify-content-between">
                                                <button type="button" class="btn btn-secondary tab-prev-btn">
                                                    <i class="fas fa-arrow-left me-2"></i>Previous
                                                </button>
                                                <div>
                                                    <button type="submit" name="action" value="save_finish" class="btn btn-success">
                                                        <i class="fas fa-check me-2"></i>Save & Finish
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block additional_js %}
<script src="{{ url_for('static', filename='akademi/vendor/jquery-smartwizard/dist/js/jquery.smartWizard.js')}}"></script>
<script src="{{ url_for('static', filename='akademi/vendor/bootstrap-datepicker-master/js/bootstrap-datepicker.min.js')}}"></script>
<script>
$(document).ready(function() {
    // Initialize datepicker
    $('.datepicker').datepicker({
        format: 'yyyy-mm-dd',
        autoclose: true,
        todayHighlight: true
    });
    
    // Initialize Smart Wizard
    var currentTab = {{ current_tab|default(0) }};
    $('#smartwizard').smartWizard({
        selected: currentTab,
        theme: 'dots',
        justified: true,
        autoAdjustHeight: false,
        transition: {
            animation: 'slide-horizontal'
        },
        toolbarSettings: {
            toolbarPosition: 'none'
        }
    });
    
    // Custom navigation
    $('.tab-next-btn').on('click', function() {
        $('#smartwizard').smartWizard("next");
        return true;
    });
    
    $('.tab-prev-btn').on('click', function() {
        $('#smartwizard').smartWizard("prev");
        return true;
    });
    
    // Track current tab before submit
    $('#smartwizard').on('leaveStep', function(e, anchorObject, currentStepIndex, nextStepIndex, stepDirection) {
        $('#current_tab').val(nextStepIndex);
    });
    
    // Image preview
    $("#imageUpload").change(function() {
        if (this.files && this.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                $('#imagePreview').css('background-image', 'url('+e.target.result +')');
            }
            reader.readAsDataURL(this.files[0]);
        }
    });
    
    $('.remove-img').on('click', function() {
        var imageUrl = "{{ url_for('static', filename='akademi/images/no-img-avatar.png')}}";
        $('#imagePreview').css('background-image', 'url(' + imageUrl + ')');
        $('#imageUpload').val('');
    });
    
    // Add Previous School
    $('#add-prev-school').on('click', function() {
        var html = `
            <div class="prev-school-row mb-3 p-3 border rounded bg-light">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">School Name<span class="required">*</span></label>
                            <input type="text" name="prev_school_name[]" class="form-control" required>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Last Class</label>
                            <input type="text" name="prev_school_class[]" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">TC Number</label>
                            <input type="text" name="prev_school_tc[]" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-danger btn-sm mt-4 remove-prev-school">Remove</button>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">TC Date</label>
                            <input type="text" name="prev_school_tc_date[]" class="form-control datepicker">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Last Percentage</label>
                            <input type="number" name="prev_school_percentage[]" class="form-control" step="0.01">
                        </div>
                    </div>
                </div>
            </div>
        `;
        $('#previous-schools-container').append(html);
        $('.datepicker').datepicker({
            format: 'yyyy-mm-dd',
            autoclose: true
        });
    });
    
    // Remove Previous School
    $(document).on('click', '.remove-prev-school', function() {
        $(this).closest('.prev-school-row').remove();
    });
    
    // Add Sibling
    $('#add-sibling').on('click', function() {
        var html = `
            <div class="sibling-row mb-3 p-3 border rounded bg-light">
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Sibling Name<span class="required">*</span></label>
                            <input type="text" name="sibling_name[]" class="form-control" required>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">Class</label>
                            <input type="text" name="sibling_class[]" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">Admission No</label>
                            <input type="text" name="sibling_admission[]" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" name="sibling_same_school[]" value="1">
                            <label class="form-check-label">Same School</label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-danger btn-sm mt-4 remove-sibling">Remove</button>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Other School Name</label>
                            <input type="text" name="sibling_other_school[]" class="form-control" placeholder="If not in same school">
                        </div>
                    </div>
                </div>
            </div>
        `;
        $('#siblings-container').append(html);
    });
    
    // Remove Sibling
    $(document).on('click', '.remove-sibling', function() {
        $(this).closest('.sibling-row').remove();
    });
    
    // Add Document Row
    $('#add-document-row').on('click', function() {
        var html = `
            <div class="document-upload-row mb-3 p-3 border rounded bg-light">
                <div class="row align-items-end">
                    <div class="col-md-4">
                        <label class="form-label">Document Type<span class="required">*</span></label>
                        <select name="doc_type[]" class="form-control" required>
                            <option value="">Select Type</option>
                            <option value="Birth Certificate">Birth Certificate</option>
                            <option value="Aadhar Card">Aadhar Card</option>
                            <option value="Transfer Certificate">Transfer Certificate</option>
                            <option value="Marksheet">Marksheet</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Upload File<span class="required">*</span></label>
                        <input type="file" name="doc_file[]" class="form-control" required>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-danger btn-sm remove-doc-row">Remove</button>
                    </div>
                </div>
            </div>
        `;
        $('#upload-documents-container').append(html);
    });
    
    // Remove Document Row
    $(document).on('click', '.remove-doc-row', function() {
        $(this).closest('.document-upload-row').remove();
    });
    
    // Delete uploaded document
    $(document).on('click', '.delete-doc', function() {
        if (confirm('Are you sure you want to delete this document?')) {
            var docId = $(this).data('doc-id');
            var row = $(this).closest('tr');
            
            $.ajax({
                url: "{{ url_for('school.delete_student_document', tenant_slug=school.slug, student_id=student.id, doc_id=0) }}".replace('/0', '/' + docId),
                method: 'POST',
                success: function(response) {
                    row.remove();
                    alert('Document deleted successfully');
                },
                error: function() {
                    alert('Error deleting document');
                }
            });
        }
    });
});
</script>
{% endblock %}
